<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–£–ù–ö–ï–† ‚Ä¢ –û–Ω–ª–∞–π–Ω –ì—Ä–∞ v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@300;500;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #ff6b35;
            --danger: #d32f2f;
            --dark: #1a1a1a;
            --darker: #0d0d0d;
            --light: #f5f5f5;
            --accent: #ffd23f;
            --bunker-green: #3bba5c;
            --metal: #5a6473;
            --purple: #9c27b0;
            --blue: #2196f3;
        }

        body {
            font-family: 'Oswald', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, #2a1a0a 100%);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(0deg, rgba(0,0,0,0.1) 0px, transparent 1px, transparent 2px, rgba(0,0,0,0.1) 3px),
                radial-gradient(circle at 20% 50%, rgba(255, 107, 53, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            border-bottom: 3px solid var(--primary);
            position: relative;
        }

        h1 {
            font-family: 'Bebas Neue', cursive;
            font-size: 5rem;
            letter-spacing: 8px;
            color: var(--primary);
            text-shadow: 4px 4px 0 rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--accent);
            letter-spacing: 3px;
            font-weight: 300;
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: rgba(26, 26, 26, 0.95);
            border: 2px solid var(--metal);
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), #ff8c5a);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-family: 'Oswald', sans-serif;
            font-weight: 500;
            letter-spacing: 2px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 107, 53, 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--metal), #6b7784);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e57373);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--bunker-green), #4caf50);
        }

        .btn-small {
            padding: 8px 20px;
            font-size: 0.9rem;
        }

        input[type="text"], input[type="number"], input[type="password"], select {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1rem;
            font-family: 'Courier Prime', monospace;
            background: rgba(13, 13, 13, 0.8);
            border: 2px solid var(--metal);
            border-radius: 8px;
            color: var(--light);
            margin: 10px 0;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .room-code {
            font-family: 'Courier Prime', monospace;
            font-size: 2.5rem;
            color: var(--accent);
            background: rgba(13, 13, 13, 0.8);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            letter-spacing: 8px;
            margin: 20px 0;
            border: 2px solid var(--accent);
            font-weight: bold;
        }

        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .player-item {
            background: rgba(13, 13, 13, 0.6);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--bunker-green);
        }

        .player-item.host::before {
            content: 'üëë ';
        }

        .player-item.eliminated {
            opacity: 0.5;
            border-left-color: var(--danger);
            text-decoration: line-through;
        }

        .character-section {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.95), rgba(42, 26, 10, 0.95));
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 25px;
            margin: 15px 0;
        }

        .profession-header {
            text-align: center;
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }

        .characteristic {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
            padding: 12px;
            background: rgba(13, 13, 13, 0.4);
            border-radius: 6px;
        }

        .characteristic-label {
            color: var(--accent);
            font-weight: 500;
        }

        .characteristic-value {
            color: var(--light);
            flex: 1;
            margin: 0 15px;
        }

        .hidden-value {
            filter: blur(8px);
            user-select: none;
        }

        .revealed-to-all {
            color: var(--bunker-green);
            font-weight: 500;
        }

        .card-item {
            background: rgba(13, 13, 13, 0.7);
            border: 2px solid var(--purple);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }

        .card-item.action-card {
            border-color: var(--blue);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--accent);
        }

        .card-uses {
            background: rgba(255, 107, 53, 0.3);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--light);
        }

        .card-description {
            color: var(--light);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .bunker-conditions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .condition-item {
            background: rgba(13, 13, 13, 0.6);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .condition-item.positive {
            border: 2px solid var(--bunker-green);
        }

        .condition-item.negative {
            border: 2px solid var(--danger);
        }

        .condition-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .condition-title {
            font-weight: 500;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .condition-description {
            font-size: 0.9rem;
            color: var(--light);
        }

        .scenario-card {
            background: linear-gradient(135deg, rgba(211, 47, 47, 0.2), rgba(255, 107, 53, 0.2));
            border: 3px solid var(--danger);
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .scenario-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 2.5rem;
            color: var(--danger);
            margin-bottom: 15px;
            letter-spacing: 3px;
            text-align: center;
        }

        .scenario-desc {
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--light);
            text-align: center;
        }

        .chat-container {
            background: rgba(13, 13, 13, 0.8);
            border: 2px solid var(--metal);
            border-radius: 12px;
            padding: 20px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .chat-message {
            margin: 8px 0;
            padding: 10px;
            background: rgba(26, 26, 26, 0.6);
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }

        .chat-message.system {
            border-left-color: var(--accent);
            background: rgba(255, 210, 63, 0.1);
        }

        .chat-message-author {
            color: var(--accent);
            font-weight: 500;
            margin-bottom: 5px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .overlay.show {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, rgba(26, 26, 26, 0.98), rgba(42, 26, 10, 0.98));
            border: 4px solid var(--danger);
            border-radius: 16px;
            padding: 40px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 3rem;
            color: var(--danger);
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 3px;
        }

        .modal-content {
            color: var(--light);
            line-height: 1.8;
            font-size: 1.1rem;
        }

        .eliminated-player {
            background: rgba(211, 47, 47, 0.3);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
            border: 2px solid var(--danger);
        }

        .survivors-list {
            background: rgba(59, 186, 92, 0.2);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid var(--bunker-green);
        }

        .timer {
            font-family: 'Courier Prime', monospace;
            font-size: 3rem;
            color: var(--accent);
            text-align: center;
            padding: 20px;
            background: rgba(13, 13, 13, 0.8);
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid var(--accent);
            font-weight: bold;
        }

        .timer.warning {
            color: var(--primary);
            border-color: var(--primary);
        }

        .timer.critical {
            color: var(--danger);
            border-color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .vote-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .vote-option {
            background: rgba(13, 13, 13, 0.6);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--metal);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .vote-option:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }

        .vote-option.selected {
            border-color: var(--bunker-green);
            background: rgba(59, 186, 92, 0.2);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            h1 { font-size: 3rem; }
            .room-code { font-size: 1.8rem; }
            .timer { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ë–£–ù–ö–ï–†</h1>
            <div class="subtitle">–•—Ç–æ –∑–∞—Å–ª—É–≥–æ–≤—É—î –≤–∏–∂–∏—Ç–∏?</div>
        </div>

        <!-- –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é -->
        <div id="menuScreen" class="screen active">
            <div class="card">
                <h2 style="text-align: center; font-size: 2rem; margin-bottom: 30px; color: var(--primary);">–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é</h2>
                <div class="action-buttons">
                    <button class="btn" onclick="showCreateRoom()">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É</button>
                    <button class="btn btn-secondary" onclick="showJoinRoom()">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
                    <button class="btn btn-secondary" onclick="showAISettings()">‚öôÔ∏è AI</button>
                </div>
                
                <div id="aiStatusIndicator" style="margin-top: 20px; padding: 15px; background: rgba(255, 210, 63, 0.2); border: 2px solid var(--accent); border-radius: 8px; text-align: center;">
                    <div style="color: var(--accent);">AI –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ</div>
                </div>
            </div>
        </div>

        <!-- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è AI -->
        <div id="aiSettingsScreen" class="screen">
            <div class="card">
                <h2 style="text-align: center; font-size: 2rem; margin-bottom: 30px; color: var(--primary);">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è AI</h2>
                
                <select id="aiProviderSelect" onchange="updateAIProvider()">
                    <option value="none">–ë–µ–∑ AI</option>
                    <option value="gemini">Google Gemini (–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ)</option>
                    <option value="openai">OpenAI ChatGPT</option>
                </select>

                <div id="aiKeySection" style="display: none;">
                    <input type="password" id="aiKeyInput" placeholder="API –∫–ª—é—á">
                    <div id="aiInstructions" style="margin-top: 15px; padding: 15px; background: rgba(13, 13, 13, 0.4); border-radius: 8px; font-size: 0.9rem;"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-success" onclick="saveAISettings()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    <button class="btn btn-secondary" onclick="showMenu()">–ù–∞–∑–∞–¥</button>
                </div>
            </div>
        </div>

        <!-- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏ -->
        <div id="createRoomScreen" class="screen">
            <div class="card">
                <h2 style="text-align: center; font-size: 2rem; margin-bottom: 30px; color: var(--primary);">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É</h2>
                <input type="text" id="hostNameInput" placeholder="–í–∞—à–µ —ñ–º'—è" maxlength="20">
                <input type="number" id="maxPlayersInput" min="4" max="8" value="6" placeholder="–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥—Ä–∞–≤—Ü—ñ–≤ (4-8)">
                <input type="number" id="discussionTimeInput" min="1" max="15" value="5" placeholder="–ß–∞—Å –æ–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è (—Ö–≤–∏–ª–∏–Ω)">
                <div class="action-buttons">
                    <button class="btn" onclick="createRoom()">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                    <button class="btn btn-secondary" onclick="showMenu()">–ù–∞–∑–∞–¥</button>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∏—î–¥–Ω–∞–Ω–Ω—è -->
        <div id="joinRoomScreen" class="screen">
            <div class="card">
                <h2 style="text-align: center; font-size: 2rem; margin-bottom: 30px; color: var(--primary);">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</h2>
                <input type="text" id="playerNameInput" placeholder="–í–∞—à–µ —ñ–º'—è" maxlength="20">
                <input type="text" id="roomCodeInput" placeholder="–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏ (4 —Å–∏–º–≤–æ–ª–∏)" maxlength="4" style="text-transform: uppercase;">
                <div class="action-buttons">
                    <button class="btn" onclick="joinRoom()">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
                    <button class="btn btn-secondary" onclick="showMenu()">–ù–∞–∑–∞–¥</button>
                </div>
            </div>
        </div>

        <!-- –õ–æ–±—ñ -->
        <div id="lobbyScreen" class="screen">
            <div class="card">
                <h2 style="text-align: center; font-size: 2rem; margin-bottom: 20px; color: var(--primary);">–ö—ñ–º–Ω–∞—Ç–∞</h2>
                <div class="room-code" id="roomCodeDisplay"></div>
                
                <div style="background: rgba(13, 13, 13, 0.8); padding: 15px; border-radius: 8px; margin: 15px 0; display: flex; gap: 10px;">
                    <input type="text" id="shareLinkInput" readonly style="flex: 1; margin: 0;">
                    <button class="btn btn-small" onclick="copyLink()">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                </div>

                <div style="text-align: center; margin: 20px 0; padding: 15px; background: rgba(59, 186, 92, 0.2); border: 2px solid var(--bunker-green); border-radius: 8px;">
                    <span id="playerCountDisplay" style="color: var(--bunker-green); font-weight: 500;"></span>
                </div>

                <h3 style="color: var(--accent); margin: 20px 0;">–ì—Ä–∞–≤—Ü—ñ:</h3>
                <div class="player-list" id="lobbyPlayerList"></div>

                <div class="action-buttons" id="lobbyActions"></div>
            </div>
        </div>

        <!-- –ì—Ä–∞ -->
        <div id="gameScreen" class="screen">
            <div style="text-align: center; font-size: 1.8rem; color: var(--accent); margin: 20px 0; padding: 15px; background: rgba(13, 13, 13, 0.6); border-radius: 8px;">
                <span id="phaseIndicator">–û–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è</span>
            </div>
            
            <div id="timerContainer" style="display: none;">
                <div class="timer" id="gameTimer">05:00</div>
            </div>

            <div class="grid-2">
                <div>
                    <div class="scenario-card" id="scenarioCard"></div>
                    <div class="bunker-conditions" id="bunkerConditions"></div>
                </div>

                <div>
                    <h3 style="color: var(--accent); margin-bottom: 15px;">üí¨ –ß–∞—Ç</h3>
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages"></div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="chatInput" placeholder="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." maxlength="200" style="flex: 1; margin: 0;">
                            <button class="btn btn-small" onclick="sendMessage()">‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–∂ -->
            <div class="card">
                <h3 style="color: var(--primary); margin-bottom: 20px; text-align: center; font-size: 1.8rem;">–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–∂</h3>
                <div class="character-section" id="myCharacter"></div>
                
                <h4 style="color: var(--purple); margin: 20px 0;">üÉè –ö–∞—Ä—Ç–∫–∏ —É–º–æ–≤</h4>
                <div id="myConditionCards"></div>
                
                <h4 style="color: var(--blue); margin: 20px 0;">üéØ –ö–∞—Ä—Ç–∫–∏ –¥—ñ–π</h4>
                <div id="myActionCards"></div>
            </div>

            <!-- –Ü–Ω—à—ñ –≥—Ä–∞–≤—Ü—ñ -->
            <div class="card">
                <h3 style="color: var(--primary); margin-bottom: 20px; text-align: center; font-size: 1.8rem;">–Ü–Ω—à—ñ –≥—Ä–∞–≤—Ü—ñ</h3>
                <div id="otherPlayersContainer"></div>
            </div>

            <!-- –ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è -->
            <div class="card" id="votingSection" style="display: none;">
                <h3 style="color: var(--danger); margin-bottom: 20px; text-align: center; font-size: 1.8rem;">–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è</h3>
                <div class="vote-container" id="voteContainer"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-danger" onclick="submitVote()" id="submitVoteBtn">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
                </div>
            </div>

            <div class="action-buttons" id="gameActions"></div>
        </div>

        <!-- –ö—ñ–Ω–µ—Ü—å –≥—Ä–∏ -->
        <div id="endScreen" class="screen">
            <div class="card">
                <h2 style="text-align: center; font-size: 3rem; margin-bottom: 30px; color: var(--bunker-green);">–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
                <div id="winnersContainer"></div>
                <div class="action-buttons">
                    <button class="btn" onclick="location.reload()">–ù–æ–≤–∞ –≥—Ä–∞</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay –¥–ª—è –º–æ–¥–∞–ª–æ–∫ -->
    <div class="overlay" id="overlay" onclick="closeModal()"></div>
    <div class="modal" id="modal" onclick="event.stopPropagation()">
        <div id="modalContent"></div>
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="closeModal()">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>

    <script type="module">
        // === –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü ===
        window.gameState = {
            roomCode: '',
            playerId: null,
            players: [],
            currentPlayer: null,
            isHost: false,
            gameStarted: false,
            phase: 'lobby',
            scenario: null,
            bunkerCapacity: 0,
            bunkerConditions: [],
            currentVote: null,
            votingResults: {},
            timerStartTime: null,
            timerDuration: 300,
            discussionTime: 5,
            messages: [],
            finalStory: null
        };

        window.aiConfig = {
            provider: localStorage.getItem('ai_provider') || 'none',
            apiKey: localStorage.getItem('ai_key') || ''
        };

        // === –ë–ê–ó–ò –î–ê–ù–ò–• ===
        const characterDB = {
            professions: [
                '–õ—ñ–∫–∞—Ä-—Ö—ñ—Ä—É—Ä–≥', '–í—á–∏—Ç–µ–ª—å', '–Ü–Ω–∂–µ–Ω–µ—Ä', '–ü—Ä–æ–≥—Ä–∞–º—ñ—Å—Ç', '–ï–ª–µ–∫—Ç—Ä–∏–∫', '–°–∞–Ω—Ç–µ—Ö–Ω—ñ–∫',
                '–ö—É—Ö–∞—Ä', '–§–µ—Ä–º–µ—Ä', '–í–µ—Ç–µ—Ä–∏–Ω–∞—Ä', '–ü—Å–∏—Ö–æ–ª–æ–≥', '–ú–µ—Ö–∞–Ω—ñ–∫', '–ë—É–¥—ñ–≤–µ–ª—å–Ω–∏–∫',
                '–ü–æ–∂–µ–∂–Ω–∏–∫', '–ü–æ–ª—ñ—Ü–µ–π—Å—å–∫–∏–π', '–í—ñ–π—Å—å–∫–æ–≤–∏–π', '–ü—ñ–ª–æ—Ç', '–ú–µ—Ö–∞–Ω—ñ–∫', '–í–æ–¥—ñ–π',
                '–ë—ñ–æ–ª–æ–≥', '–•—ñ–º—ñ–∫', '–§—ñ–∑–∏–∫', '–ú–∞—Ç–µ–º–∞—Ç–∏–∫', '–ê—Ä—Ö—ñ—Ç–µ–∫—Ç–æ—Ä', '–î–∏–∑–∞–π–Ω–µ—Ä'
            ],
            health: [
                '–í—ñ–¥–º—ñ–Ω–Ω–µ –∑–¥–æ—Ä–æ–≤\'—è', '–•–æ—Ä–æ—à–µ –∑–¥–æ—Ä–æ–≤\'—è', '–î—ñ–∞–±–µ—Ç (–ø—ñ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º)', 
                '–ê—Å—Ç–º–∞ (–ª–µ–≥–∫–∞)', '–ê–ª–µ—Ä–≥—ñ—è', '–ö–æ—Ä–æ—Ç–∫–æ–∑–æ—Ä—ñ—Å—Ç—å', '–ê—Ä—Ç—Ä–∏—Ç', '–ú—ñ–≥—Ä–µ–Ω—å'
            ],
            hobbies: [
                '–ü–æ–ª—é–≤–∞–Ω–Ω—è', '–†–∏–±–æ–ª–æ–≤–ª—è', '–°–∞–¥—ñ–≤–Ω–∏—Ü—Ç–≤–æ', '–ö—É–ª—ñ–Ω–∞—Ä—ñ—è', '–°—Ç–æ–ª—è—Ä—Å—Ç–≤–æ',
                '–ú–∞–ª—é–≤–∞–Ω–Ω—è', '–ú—É–∑–∏–∫–∞', '–ô–æ–≥–∞', '–ë—ñ–≥', '–ü–ª–∞–≤–∞–Ω–Ω—è', '–®–∞—Ö–∏', '–ß–∏—Ç–∞–Ω–Ω—è'
            ],
            baggage: [
                '–ù—ñ–∂-–º—É–ª—å—Ç–∏—Ç—É–ª', '–ê–ø—Ç–µ—á–∫–∞', '–ó–∞–ø–∞–ª—å–Ω–∏—á–∫–∞', '–õ—ñ—Ö—Ç–∞—Ä–∏–∫', '–ú–æ—Ç—É–∑–∫–∞',
                '–ö–æ–º–ø–∞—Å', '–†–∞–¥—ñ–æ', '–¢–µ—Ä–º–æ—Å', '–°—É—Ö–ø–∞–π–æ–∫', '–ù–∞—Å—ñ–Ω–Ω—è', '–ö–Ω–∏–≥–∞ –≤–∏–∂–∏–≤–∞–Ω–Ω—è'
            ],
            phobias: [
                '–ö–ª–∞—É—Å—Ç—Ä–æ—Ñ–æ–±—ñ—è', '–ê–∫—Ä–æ—Ñ–æ–±—ñ—è', '–ê—Ä–∞—Ö–Ω–æ—Ñ–æ–±—ñ—è', '–ê–∫–≤–∞—Ñ–æ–±—ñ—è', '–ü—ñ—Ä–æ—Ñ–æ–±—ñ—è',
                '–ì–µ–º–æ—Ñ–æ–±—ñ—è', '–ù—ñ–∫—Ç–æ—Ñ–æ–±—ñ—è', '–°–æ—Ü—ñ–æ—Ñ–æ–±—ñ—è', '–¢–∞–Ω–∞—Ç–æ—Ñ–æ–±—ñ—è'
            ],
            traits: [
                '–û–ø—Ç–∏–º—ñ—Å—Ç', '–õ—ñ–¥–µ—Ä', '–ö—Ä–µ–∞—Ç–∏–≤–Ω–∏–π', '–ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π', '–ï–º–ø–∞—Ç', '–ü–µ—Ä—Ñ–µ–∫—Ü—ñ–æ–Ω—ñ—Å—Ç',
                '–•—Ä–∞–±—Ä–∏–π', '–¢–µ—Ä–ø–ª—è—á–∏–π', '–û—Ä–≥–∞–Ω—ñ–∑–æ–≤–∞–Ω–∏–π', '–°–ø–æ–Ω—Ç–∞–Ω–Ω–∏–π'
            ],
            additional: [
                '–î–æ—Å–≤—ñ–¥ –≤–∏–∂–∏–≤–∞–Ω–Ω—è', '–ö–æ–ª–∏—à–Ω—ñ–π –≤—ñ–π—Å—å–∫–æ–≤–∏–π', '–ú–∞—î –¥—ñ—Ç–µ–π', '–í–∞–≥—ñ—Ç–Ω–∞',
                '–ó–Ω–∞—î 5 –º–æ–≤', '–í–æ–¥—ñ–π—Å—å–∫—ñ –ø—Ä–∞–≤–∞', '–ú–µ–¥–∏—á–Ω–∞ –æ—Å–≤—ñ—Ç–∞'
            ]
        };

        const scenarios = [
            { name: '–Ø–¥–µ—Ä–Ω–∞ –≤—ñ–π–Ω–∞', duration: '100 —Ä–æ–∫—ñ–≤', threat: '–†–∞–¥—ñ–∞—Ü—ñ—è, —è–¥–µ—Ä–Ω–∞ –∑–∏–º–∞' },
            { name: '–ó–æ–º–±—ñ-–∞–ø–æ–∫–∞–ª—ñ–ø—Å–∏—Å', duration: '5 —Ä–æ–∫—ñ–≤', threat: '–ó–æ–º–±—ñ, –≥–æ–ª–æ–¥' },
            { name: '–ê—Å—Ç–µ—Ä–æ—ó–¥', duration: '50 —Ä–æ–∫—ñ–≤', threat: '–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Å–æ–Ω—Ü—è' },
            { name: '–ü–∞–Ω–¥–µ–º—ñ—è', duration: '10 —Ä–æ–∫—ñ–≤', threat: '–°–º–µ—Ä—Ç–µ–ª—å–Ω–∏–π –≤—ñ—Ä—É—Å' },
            { name: '–Ü–Ω–æ–ø–ª–∞–Ω–µ—Ç—è–Ω–∏', duration: '20 —Ä–æ–∫—ñ–≤', threat: '–ü—Ä–∏–±—É–ª—å—Ü—ñ' }
        ];

        const conditionCardsDB = [
            { name: '–Ü–º—É–Ω—ñ—Ç–µ—Ç', description: '–ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ 1 –∫–∞—Ä—Ç–∫–∏ –¥—ñ—ó', uses: 1 },
            { name: '–ù–µ–ø–æ—Ä—É—à–Ω—ñ—Å—Ç—å', description: '–ù—ñ—Ö—Ç–æ –Ω–µ –º–æ–∂–µ —Ä–æ–∑–∫—Ä–∏—Ç–∏ –≤–∞—à—É —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É', uses: 999 },
            { name: '–¢–∞—î–º–Ω–∏—Ü—è', description: '–ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ —Ä–æ–∑–∫—Ä–∏—Ç—Ç—è –±—É–¥—å-—è–∫–æ—ó —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏', uses: 2 },
            { name: '–©–∏—Ç', description: '–ü–æ–≤–Ω–∏–π –∑–∞—Ö–∏—Å—Ç 1 —Ä–∞–∑', uses: 1 }
        ];

        const actionCardsDB = [
            { name: '–û–±–º—ñ–Ω', description: '–ü–æ–º—ñ–Ω—è—Ç–∏ –±—É–¥—å-—è–∫—É —Å–≤–æ—é —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É –Ω–∞ –≤–∏–ø–∞–¥–∫–æ–≤—É', uses: 1 },
            { name: '–ö–æ–ø—ñ—è', description: '–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –±—É–¥—å-—è–∫—É —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è', uses: 1 },
            { name: '–†–æ–∑–∫—Ä–∏—Ç—Ç—è', description: '–ü—Ä–∏–º—É—Å–æ–≤–æ —Ä–æ–∑–∫—Ä–∏—Ç–∏ 1 —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è', uses: 1 },
            { name: '–ó–º—ñ–Ω–∞ —Å—Ç–∞—Ç—ñ', description: '–ó–º—ñ–Ω–∏—Ç–∏ —Å–≤–æ—é —Å—Ç–∞—Ç—å', uses: 1 },
            { name: '–û–º–æ–ª–æ–¥–∂–µ–Ω–Ω—è', description: '–ó–º–µ–Ω—à–∏—Ç–∏ —Å–≤—ñ–π –≤—ñ–∫ –Ω–∞ 10 —Ä–æ–∫—ñ–≤', uses: 1 },
            { name: '–õ—ñ–∫—É–≤–∞–Ω–Ω—è', description: '–ó–º—ñ–Ω–∏—Ç–∏ –∑–¥–æ—Ä–æ–≤\'—è –Ω–∞ "–í—ñ–¥–º—ñ–Ω–Ω–µ"', uses: 1 }
        ];

        const bunkerConditionsDB = [
            { type: 'positive', icon: 'üå±', name: '–û—Ä–∞–Ω–∂–µ—Ä–µ—è', description: '–Ñ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤–∏—Ä–æ—â—É–≤–∞—Ç–∏ —ó–∂—É' },
            { type: 'positive', icon: 'üíß', name: '–û—á–∏—â–µ–Ω–Ω—è –≤–æ–¥–∏', description: '–°–∏—Å—Ç–µ–º–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó –≤–æ–¥–∏' },
            { type: 'positive', icon: 'üìö', name: '–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞', description: '–ó–Ω–∞–Ω–Ω—è –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è' },
            { type: 'positive', icon: 'üîß', name: '–ú–∞–π—Å—Ç–µ—Ä–Ω—è', description: '–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ —Ç–∞ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è' },
            { type: 'positive', icon: '‚ö°', name: '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä', description: '–ê–≤—Ç–æ–Ω–æ–º–Ω–µ –µ–ª–µ–∫—Ç—Ä–æ–∂–∏–≤–ª–µ–Ω–Ω—è' },
            { type: 'negative', icon: 'üçû', name: '–ú–∞–ª–æ —ó–∂—ñ', description: '–ó–∞–ø–∞—Å—ñ–≤ –Ω–∞ 6 –º—ñ—Å—è—Ü—ñ–≤' },
            { type: 'negative', icon: '‚ùÑÔ∏è', name: '–•–æ–ª–æ–¥', description: '–ü–æ–≥–∞–Ω–µ –æ–ø–∞–ª–µ–Ω–Ω—è' },
            { type: 'negative', icon: 'üîä', name: '–®—É–º', description: '–ü–æ–≥–∞–Ω–∞ –∑–≤—É–∫–æ—ñ–∑–æ–ª—è—Ü—ñ—è' },
            { type: 'negative', icon: 'ü¶†', name: '–í–æ–ª–æ–≥—ñ—Å—Ç—å', description: '–†–∏–∑–∏–∫ –∑–∞—Ö–≤–æ—Ä—é–≤–∞–Ω—å' }
        ];

        // === –£–¢–ò–õ–Ü–¢–ò ===
        function randomElement(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            return Array.from({length: 4}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
        }

        function generateCharacter() {
            return {
                profession: randomElement(characterDB.professions),
                health: randomElement(characterDB.health),
                hobby: randomElement(characterDB.hobbies),
                baggage: randomElement(characterDB.baggage),
                phobia: randomElement(characterDB.phobias),
                trait: randomElement(characterDB.traits),
                additional: randomElement(characterDB.additional),
                age: Math.floor(Math.random() * 60) + 18,
                gender: Math.random() > 0.5 ? '–ß–æ–ª–æ–≤—ñ–∫' : '–ñ—ñ–Ω–∫–∞'
            };
        }

        function generateCards() {
            const conditionCards = Array.from({length: 2}, () => ({
                ...randomElement(conditionCardsDB),
                id: Date.now() + Math.random(),
                remainingUses: null
            })).map(card => ({
                ...card,
                remainingUses: card.uses
            }));

            const actionCards = Array.from({length: 2}, () => ({
                ...randomElement(actionCardsDB),
                id: Date.now() + Math.random(),
                remainingUses: null
            })).map(card => ({
                ...card,
                remainingUses: card.uses
            }));

            return { conditionCards, actionCards };
        }

        function generateBunkerConditions(playerCount) {
            const positive = Array.from({length: 2}, () => 
                bunkerConditionsDB.filter(c => c.type === 'positive')[Math.floor(Math.random() * 5)]
            );
            const negative = Array.from({length: 2}, () => 
                bunkerConditionsDB.filter(c => c.type === 'negative')[Math.floor(Math.random() * 4)]
            );
            
            const foodMonths = Math.floor(playerCount * (Math.random() * 4 + 2));
            const food = {
                type: foodMonths >= playerCount * 3 ? 'positive' : 'negative',
                icon: 'üçû',
                name: '–ó–∞–ø–∞—Å–∏ —ó–∂—ñ',
                description: `${foodMonths} –º—ñ—Å—è—Ü—ñ–≤ —ó–∂—ñ (${playerCount} –≥—Ä–∞–≤—Ü—ñ–≤)`
            };

            return [food, ...positive, ...negative];
        }

        // === AI –§–£–ù–ö–¶–Ü–á ===
        window.addEventListener('DOMContentLoaded', updateAIStatusIndicator);

        function updateAIStatusIndicator() {
            const indicator = document.getElementById('aiStatusIndicator');
            if (!indicator) return;
            
            if (window.aiConfig.provider === 'none' || !window.aiConfig.apiKey) {
                indicator.innerHTML = '<div style="color: var(--accent);">‚ö†Ô∏è AI –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ</div>';
                indicator.style.background = 'rgba(255, 210, 63, 0.2)';
            } else {
                const names = { gemini: 'ü§ñ Gemini', openai: 'ü§ñ OpenAI' };
                indicator.innerHTML = `<div style="color: var(--bunker-green);">‚úÖ ${names[window.aiConfig.provider]}</div>`;
                indicator.style.background = 'rgba(59, 186, 92, 0.2)';
                indicator.style.borderColor = 'var(--bunker-green)';
            }
        }

        window.showAISettings = () => {
            showScreen('aiSettingsScreen');
            document.getElementById('aiProviderSelect').value = window.aiConfig.provider;
            updateAIProvider();
        }

        window.updateAIProvider = () => {
            const provider = document.getElementById('aiProviderSelect').value;
            const section = document.getElementById('aiKeySection');
            const instructions = document.getElementById('aiInstructions');
            
            if (provider === 'none') {
                section.style.display = 'none';
            } else {
                section.style.display = 'block';
                instructions.innerHTML = provider === 'gemini' 
                    ? '<a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--primary);">–û—Ç—Ä–∏–º–∞—Ç–∏ Gemini –∫–ª—é—á (–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ)</a>'
                    : '<a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--primary);">–û—Ç—Ä–∏–º–∞—Ç–∏ OpenAI –∫–ª—é—á</a>';
            }
        }

        window.saveAISettings = () => {
            const provider = document.getElementById('aiProviderSelect').value;
            const apiKey = document.getElementById('aiKeyInput').value.trim();
            
            if (provider !== 'none' && !apiKey) {
                alert('–í–≤–µ–¥—ñ—Ç—å API –∫–ª—é—á');
                return;
            }
            
            window.aiConfig = { provider, apiKey };
            localStorage.setItem('ai_provider', provider);
            localStorage.setItem('ai_key', apiKey);
            
            updateAIStatusIndicator();
            alert('–ó–±–µ—Ä–µ–∂–µ–Ω–æ!');
            showMenu();
        }

        async function callAI(prompt, maxTokens = 300) {
            if (window.aiConfig.provider === 'none' || !window.aiConfig.apiKey) return '';

            try {
                if (window.aiConfig.provider === 'gemini') {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${window.aiConfig.apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                } else if (window.aiConfig.provider === 'openai') {
                    const res = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${window.aiConfig.apiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-3.5-turbo",
                            messages: [{ role: "user", content: prompt }],
                            max_tokens: maxTokens
                        })
                    });
                    const data = await res.json();
                    return data.choices?.[0]?.message?.content || '';
                }
            } catch (e) {
                console.error('AI error:', e);
            }
            return '';
        }

        async function generateScenarioDescription(scenario) {
            const prompt = `–û–ø–∏—à–∏ –¥–µ—Ç–∞–ª—å–Ω–æ –∞–ø–æ–∫–∞–ª—ñ–ø—Ç–∏—á–Ω–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π "${scenario.name}" –¥–ª—è –≥—Ä–∏ "–ë—É–Ω–∫–µ—Ä". 
–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å: ${scenario.duration}. –ó–∞–≥—Ä–æ–∑–∞: ${scenario.threat}.
–ù–∞–ø–∏—à–∏ 4-6 —Ä–µ—á–µ–Ω—å –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ–≥–æ –æ–ø–∏—Å—É —â–æ —Å—Ç–∞–ª–æ—Å—è –∑—ñ —Å–≤—ñ—Ç–æ–º. –£–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.`;
            
            const desc = await callAI(prompt);
            return desc || `${scenario.name}. ${scenario.threat}. –õ—é–¥—Å—Ç–≤—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–∂–∏—Ç–∏ ${scenario.duration} –≤ –±—É–Ω–∫–µ—Ä—ñ.`;
        }

        async function generateEliminationStory(player, state) {
            const alive = state.players.filter(p => !p.eliminated && p.id !== player.id);
            const prompt = `–ì—Ä–∞ "–ë—É–Ω–∫–µ—Ä". –°—Ü–µ–Ω–∞—Ä—ñ–π: ${state.scenario.name}.
–í–∏–∫–ª—é—á–µ–Ω–æ: ${player.name} (${player.character.profession}, ${player.character.age} —Ä–æ–∫—ñ–≤).
–ó–∞–ª–∏—à–∏–ª–∏—Å—è: ${alive.map(p => p.character.profession).join(', ')}.
–ù–∞–ø–∏—à–∏ 2-3 –¥—Ä–∞–º–∞—Ç–∏—á–Ω—ñ —Ä–µ—á–µ–Ω–Ω—è –ø—Ä–æ –≤–∏–≥–Ω–∞–Ω–Ω—è ${player.name} –∑ –±—É–Ω–∫–µ—Ä—É. –£–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é.`;
            
            const story = await callAI(prompt, 200);
            return story || `${player.name} –∑ –≤–∞–∂–∫–∏–º —Å–µ—Ä—Ü–µ–º –∑–∞–ª–∏—à–∞—î –±—É–Ω–∫–µ—Ä...`;
        }

        async function generateFinalStory(state) {
            const winners = state.players.filter(p => !p.eliminated);
            const prompt = `–ì—Ä–∞ "–ë—É–Ω–∫–µ—Ä". –°—Ü–µ–Ω–∞—Ä—ñ–π: ${state.scenario.name}. –ß–∞—Å: ${state.scenario.duration}.
–í–∏–∂–∏–≤—à—ñ: ${winners.map(w => `${w.character.profession} (${w.character.age} —Ä–æ–∫—ñ–≤)`).join(', ')}.
–ù–∞–ø–∏—à–∏ 4-6 —Ä–µ—á–µ–Ω—å –µ–ø—ñ—á–Ω–æ—ó –∫—ñ–Ω—Ü—ñ–≤–∫–∏ –ø—Ä–æ —ó—Ö –≤–∏–∂–∏–≤–∞–Ω–Ω—è —Ç–∞ –º–∞–π–±—É—Ç–Ω—î. –£–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é.`;
            
            const story = await callAI(prompt, 400);
            return story || `–ü—ñ—Å–ª—è ${state.scenario.duration} –≤–∏–∂–∏–≤—à—ñ –≤—ñ–¥–±—É–¥—É–≤–∞–ª–∏ —Ü–∏–≤—ñ–ª—ñ–∑–∞—Ü—ñ—é...`;
        }

        // === –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø/–ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø ===
        async function saveRoomData() {
            try {
                const data = JSON.stringify({
                    players: gameState.players,
                    scenario: gameState.scenario,
                    bunkerCapacity: gameState.bunkerCapacity,
                    bunkerConditions: gameState.bunkerConditions,
                    gameStarted: gameState.gameStarted,
                    phase: gameState.phase,
                    timerStartTime: gameState.timerStartTime,
                    timerDuration: gameState.timerDuration,
                    discussionTime: gameState.discussionTime,
                    messages: gameState.messages,
                    votingResults: gameState.votingResults,
                    finalStory: gameState.finalStory
                });
                await window.storage.set(`room_${gameState.roomCode}`, data, true);
            } catch (e) {
                localStorage.setItem(`bunker_${gameState.roomCode}`, JSON.stringify(gameState));
            }
        }

        async function loadRoomData(code) {
            try {
                const result = await window.storage.get(`room_${code}`, true);
                return result ? JSON.parse(result.value) : null;
            } catch (e) {
                const data = localStorage.getItem(`bunker_${code}`);
                return data ? JSON.parse(data) : null;
            }
        }

        // === –ù–ê–í–Ü–ì–ê–¶–Ü–Ø ===
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id)?.classList.add('active');
        }

        window.showMenu = () => showScreen('menuScreen');
        window.showCreateRoom = () => showScreen('createRoomScreen');
        window.showJoinRoom = () => showScreen('joinRoomScreen');

        // === –°–¢–í–û–†–ï–ù–ù–Ø/–ü–†–ò–Ñ–î–ù–ê–ù–ù–Ø ===
        window.createRoom = async () => {
            const name = document.getElementById('hostNameInput').value.trim();
            const max = parseInt(document.getElementById('maxPlayersInput').value);
            const time = parseInt(document.getElementById('discussionTimeInput').value);
            
            if (!name) return alert('–í–≤–µ–¥—ñ—Ç—å —ñ–º\'—è');
            if (max < 4 || max > 8) return alert('4-8 –≥—Ä–∞–≤—Ü—ñ–≤');

            gameState.roomCode = generateRoomCode();
            gameState.playerId = Date.now().toString();
            gameState.isHost = true;
            gameState.discussionTime = time;
            gameState.bunkerCapacity = Math.floor(max / 2) + Math.floor(Math.random() * 2);
            
            const scenario = randomElement(scenarios);
            const scenarioDesc = await generateScenarioDescription(scenario);
            gameState.scenario = { ...scenario, description: scenarioDesc };
            
            gameState.bunkerConditions = generateBunkerConditions(max);
            
            const cards = generateCards();
            gameState.currentPlayer = {
                id: gameState.playerId,
                name,
                character: generateCharacter(),
                isHost: true,
                eliminated: false,
                revealedToAll: [],
                ...cards
            };
            
            gameState.players = [gameState.currentPlayer];
            await saveRoomData();
            updateLobby();
            showScreen('lobbyScreen');
            startPolling();
        }

        window.joinRoom = async () => {
            const name = document.getElementById('playerNameInput').value.trim();
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (!name || !code) return alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
            if (code.length !== 4) return alert('–ö–æ–¥ = 4 —Å–∏–º–≤–æ–ª–∏');

            const roomData = await loadRoomData(code);
            if (!roomData) return alert('–ö—ñ–º–Ω–∞—Ç—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
            if (roomData.gameStarted) return alert('–ì—Ä–∞ –≤–∂–µ –ø–æ—á–∞–ª–∞—Å—è');

            gameState.roomCode = code;
            gameState.playerId = Date.now().toString();
            gameState.isHost = false;
            gameState.scenario = roomData.scenario;
            gameState.bunkerCapacity = roomData.bunkerCapacity;
            gameState.bunkerConditions = roomData.bunkerConditions;
            gameState.discussionTime = roomData.discussionTime;
            gameState.players = roomData.players;
            
            const cards = generateCards();
            gameState.currentPlayer = {
                id: gameState.playerId,
                name,
                character: generateCharacter(),
                isHost: false,
                eliminated: false,
                revealedToAll: [],
                ...cards
            };
            
            gameState.players.push(gameState.currentPlayer);
            await saveRoomData();
            updateLobby();
            showScreen('lobbyScreen');
            startPolling();
        }

        // === –õ–û–ë–Ü ===
        function updateLobby() {
            document.getElementById('roomCodeDisplay').textContent = gameState.roomCode;
            const link = window.location.href.split('?')[0] + '?room=' + gameState.roomCode;
            document.getElementById('shareLinkInput').value = link;
            
            const max = gameState.bunkerCapacity * 2;
            document.getElementById('playerCountDisplay').textContent = `${gameState.players.length} / ${max} –≥—Ä–∞–≤—Ü—ñ–≤`;
            
            const list = document.getElementById('lobbyPlayerList');
            list.innerHTML = gameState.players.map(p => 
                `<div class="player-item ${p.isHost ? 'host' : ''}">${p.name}</div>`
            ).join('');

            const actions = document.getElementById('lobbyActions');
            actions.innerHTML = '';
            if (gameState.isHost) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-success';
                btn.textContent = '–ü–æ—á–∞—Ç–∏ –≥—Ä—É';
                btn.onclick = startGame;
                btn.disabled = gameState.players.length < 4;
                actions.appendChild(btn);
            }
            const leave = document.createElement('button');
            leave.className = 'btn btn-danger';
            leave.textContent = '–í–∏–π—Ç–∏';
            leave.onclick = () => location.reload();
            actions.appendChild(leave);
        }

        window.copyLink = () => {
            const input = document.getElementById('shareLinkInput');
            input.select();
            document.execCommand('copy');
            alert('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');
        }

        // === POLLING ===
        let pollingInterval = null;
        function startPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            
            pollingInterval = setInterval(async () => {
                const data = await loadRoomData(gameState.roomCode);
                if (!data) return;

                const myPlayer = gameState.currentPlayer;
                gameState.players = data.players;
                gameState.phase = data.phase;
                gameState.timerStartTime = data.timerStartTime;
                gameState.messages = data.messages || [];
                gameState.votingResults = data.votingResults || {};
                gameState.finalStory = data.finalStory;
                
                const updated = gameState.players.find(p => p.id === myPlayer.id);
                if (updated) gameState.currentPlayer = updated;

                if (data.gameStarted && !gameState.gameStarted) {
                    gameState.gameStarted = true;
                    showGameScreen();
                    startTimerUpdate();
                }

                if (gameState.gameStarted) {
                    if (gameState.phase === 'end') {
                        clearInterval(pollingInterval);
                        endGame();
                    } else {
                        updateGameScreen();
                        updateChat();
                    }
                } else {
                    updateLobby();
                }
            }, 2000);
        }

        // === –ì–†–ê ===
        async function startGame() {
            if (!gameState.isHost) return;
            
            gameState.gameStarted = true;
            gameState.phase = 'discussion';
            gameState.timerStartTime = Date.now();
            gameState.timerDuration = gameState.discussionTime * 60;
            gameState.messages = [];
            
            await saveRoomData();
            addSystemMessage(`–ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—è! ${gameState.discussionTime} —Ö–≤–∏–ª–∏–Ω –Ω–∞ –æ–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è.`);
            await saveRoomData();
            showGameScreen();
            startTimerUpdate();
        }

        function showGameScreen() {
            showScreen('gameScreen');
            updateGameScreen();
        }

        function updateGameScreen() {
            document.getElementById('phaseIndicator').textContent = 
                gameState.phase === 'voting' ? '–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è' : '–û–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è';

            // –°—Ü–µ–Ω–∞—Ä—ñ–π
            const card = document.getElementById('scenarioCard');
            card.innerHTML = `
                <div class="scenario-title">${gameState.scenario.name}</div>
                <div class="scenario-desc">${gameState.scenario.description}</div>
                <div style="margin-top: 15px; text-align: center; color: var(--accent);">
                    –¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å: ${gameState.scenario.duration} ‚Ä¢ –ó–∞–≥—Ä–æ–∑–∞: ${gameState.scenario.threat}
                </div>
            `;

            // –£–º–æ–≤–∏ –±—É–Ω–∫–µ—Ä—É
            const cond = document.getElementById('bunkerConditions');
            cond.innerHTML = gameState.bunkerConditions.map(c => `
                <div class="condition-item ${c.type}">
                    <div class="condition-icon">${c.icon}</div>
                    <div class="condition-title">${c.name}</div>
                    <div class="condition-description">${c.description}</div>
                </div>
            `).join('');

            // –¢–∞–π–º–µ—Ä
            if (gameState.phase === 'discussion' && gameState.timerStartTime) {
                document.getElementById('timerContainer').style.display = 'block';
                updateTimerDisplay();
            } else {
                document.getElementById('timerContainer').style.display = 'none';
            }

            // –ú—ñ–π –ø–µ—Ä—Å–æ–Ω–∞–∂
            updateMyCharacter();
            
            // –Ü–Ω—à—ñ –≥—Ä–∞–≤—Ü—ñ
            updateOtherPlayers();
            
            // –ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è
            if (gameState.phase === 'voting') {
                showVoting();
            } else {
                document.getElementById('votingSection').style.display = 'none';
            }
            
            // –ö–Ω–æ–ø–∫–∏
            updateGameActions();
        }

        function updateMyCharacter() {
            const char = gameState.currentPlayer.character;
            const revealed = gameState.currentPlayer.revealedToAll || [];
            
            const html = `
                <div class="profession-header">${char.profession}</div>
                ${renderCharacteristic('gender', '–°—Ç–∞—Ç—å', char.gender, revealed)}
                ${renderCharacteristic('age', '–í—ñ–∫', `${char.age} —Ä–æ–∫—ñ–≤`, revealed)}
                ${renderCharacteristic('health', '–ó–¥–æ—Ä–æ–≤\'—è', char.health, revealed)}
                ${renderCharacteristic('hobby', '–•–æ–±—ñ', char.hobby, revealed)}
                ${renderCharacteristic('baggage', '–ë–∞–≥–∞–∂', char.baggage, revealed)}
                ${renderCharacteristic('phobia', '–§–æ–±—ñ—è', char.phobia, revealed)}
                ${renderCharacteristic('trait', '–†–∏—Å–∞', char.trait, revealed)}
                ${renderCharacteristic('additional', '–î–æ–¥–∞—Ç–∫–æ–≤–æ', char.additional, revealed)}
            `;
            document.getElementById('myCharacter').innerHTML = html;

            // –ö–∞—Ä—Ç–∫–∏ —É–º–æ–≤
            const condCards = document.getElementById('myConditionCards');
            condCards.innerHTML = (gameState.currentPlayer.conditionCards || []).map(card => `
                <div class="card-item">
                    <div class="card-header">
                        <div class="card-title">üõ°Ô∏è ${card.name}</div>
                        <div class="card-uses">${card.remainingUses === 999 ? '–ü—Ä–æ—Ç—è–≥–æ–º –≥—Ä–∏' : `${card.remainingUses} –≤–∏–∫–æ—Ä.`}</div>
                    </div>
                    <div class="card-description">${card.description}</div>
                </div>
            `).join('') || '<div style="color: var(--metal); text-align: center;">–ù–µ–º–∞—î –∫–∞—Ä—Ç–æ–∫ —É–º–æ–≤</div>';

            // –ö–∞—Ä—Ç–∫–∏ –¥—ñ–π
            const actCards = document.getElementById('myActionCards');
            actCards.innerHTML = (gameState.currentPlayer.actionCards || []).map(card => `
                <div class="card-item action-card">
                    <div class="card-header">
                        <div class="card-title">‚ö° ${card.name}</div>
                        <div class="card-uses">${card.remainingUses} –≤–∏–∫–æ—Ä.</div>
                    </div>
                    <div class="card-description">${card.description}</div>
                    ${card.remainingUses > 0 ? '<button class="btn btn-small" style="margin-top: 10px;" onclick="useActionCard(\'' + card.id + '\')">–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏</button>' : ''}
                </div>
            `).join('') || '<div style="color: var(--metal); text-align: center;">–ù–µ–º–∞—î –∫–∞—Ä—Ç–æ–∫ –¥—ñ–π</div>';
        }

        function renderCharacteristic(id, label, value, revealed) {
            const isRevealed = revealed.includes(id);
            return `
                <div class="characteristic">
                    <div class="characteristic-label">${label}:</div>
                    <div class="characteristic-value ${isRevealed ? 'revealed-to-all' : ''}">
                        ${value}
                    </div>
                    ${!isRevealed && gameState.phase !== 'end' ? 
                        '<button class="btn btn-small" onclick="revealToAll(\'' + id + '\')">–†–æ–∑–∫—Ä–∏—Ç–∏ –≤—Å—ñ–º</button>' : 
                        (isRevealed ? '<span style="color: var(--bunker-green); font-size: 0.85rem;">‚úì –†–æ–∑–∫—Ä–∏—Ç–æ</span>' : '')
                    }
                </div>
            `;
        }

        window.revealToAll = async (charId) => {
            if (!gameState.currentPlayer.revealedToAll) {
                gameState.currentPlayer.revealedToAll = [];
            }
            
            if (!gameState.currentPlayer.revealedToAll.includes(charId)) {
                gameState.currentPlayer.revealedToAll.push(charId);
                
                const idx = gameState.players.findIndex(p => p.id === gameState.currentPlayer.id);
                if (idx !== -1) gameState.players[idx] = gameState.currentPlayer;
                
                await saveRoomData();
                
                const names = { gender: '—Å—Ç–∞—Ç—å', age: '–≤—ñ–∫', health: '–∑–¥–æ—Ä–æ–≤\'—è', hobby: '—Ö–æ–±—ñ', 
                    baggage: '–±–∞–≥–∞–∂', phobia: '—Ñ–æ–±—ñ—é', trait: '—Ä–∏—Å—É', additional: '–¥–æ–¥–∞—Ç–∫–æ–≤–µ' };
                addSystemMessage(`${gameState.currentPlayer.name} —Ä–æ–∑–∫—Ä–∏–≤ ${names[charId]}`);
                await saveRoomData();
                updateMyCharacter();
            }
        }

        function updateOtherPlayers() {
            const others = gameState.players.filter(p => p.id !== gameState.currentPlayer.id);
            const container = document.getElementById('otherPlayersContainer');
            
            container.innerHTML = others.map(player => {
                const char = player.character;
                const revealed = player.revealedToAll || [];
                
                return `
                    <div class="character-section ${player.eliminated ? 'eliminated' : ''}">
                        <div class="profession-header">
                            ${player.name} - ${char.profession}
                            ${player.eliminated ? '<span style="color: var(--danger);"> (–í–∏–∫–ª—é—á–µ–Ω–∏–π)</span>' : ''}
                        </div>
                        ${renderOtherCharacteristic('–°—Ç–∞—Ç—å', char.gender, revealed.includes('gender'))}
                        ${renderOtherCharacteristic('–í—ñ–∫', `${char.age} —Ä–æ–∫—ñ–≤`, revealed.includes('age'))}
                        ${renderOtherCharacteristic('–ó–¥–æ—Ä–æ–≤\'—è', char.health, revealed.includes('health'))}
                        ${renderOtherCharacteristic('–•–æ–±—ñ', char.hobby, revealed.includes('hobby'))}
                        ${renderOtherCharacteristic('–ë–∞–≥–∞–∂', char.baggage, revealed.includes('baggage'))}
                        ${renderOtherCharacteristic('–§–æ–±—ñ—è', char.phobia, revealed.includes('phobia'))}
                        ${renderOtherCharacteristic('–†–∏—Å–∞', char.trait, revealed.includes('trait'))}
                        ${renderOtherCharacteristic('–î–æ–¥–∞—Ç–∫–æ–≤–æ', char.additional, revealed.includes('additional'))}
                    </div>
                `;
            }).join('');
        }

        function renderOtherCharacteristic(label, value, revealed) {
            return `
                <div class="characteristic">
                    <div class="characteristic-label">${label}:</div>
                    <div class="characteristic-value ${revealed ? '' : 'hidden-value'}">
                        ${revealed ? value : '???'}
                    </div>
                </div>
            `;
        }

        window.useActionCard = (cardId) => {
            alert('–§—É–Ω–∫—Ü—ñ—è –∫–∞—Ä—Ç–æ–∫ –¥—ñ–π –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ. –ë—É–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –Ω–∞—Å—Ç—É–ø–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó!');
        }

        function updateGameActions() {
            const actions = document.getElementById('gameActions');
            actions.innerHTML = '';

            if (gameState.phase === 'discussion' && gameState.isHost) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-danger';
                btn.textContent = '–ü–æ—á–∞—Ç–∏ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è';
                btn.onclick = startVoting;
                actions.appendChild(btn);
            }
        }

        // === –¢–ê–ô–ú–ï–† ===
        let timerInterval = null;
        function startTimerUpdate() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (gameState.phase !== 'discussion') {
                    clearInterval(timerInterval);
                    return;
                }
                
                updateTimerDisplay();
                
                const elapsed = Math.floor((Date.now() - gameState.timerStartTime) / 1000);
                const remaining = gameState.timerDuration - elapsed;
                
                if (remaining <= 0 && gameState.isHost) {
                    clearInterval(timerInterval);
                    startVoting();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const elapsed = Math.floor((Date.now() - gameState.timerStartTime) / 1000);
            const remaining = Math.max(0, gameState.timerDuration - elapsed);
            
            const min = Math.floor(remaining / 60);
            const sec = remaining % 60;
            const display = `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
            
            const timer = document.getElementById('gameTimer');
            timer.textContent = display;
            
            timer.classList.remove('warning', 'critical');
            if (remaining <= 30) timer.classList.add('critical');
            else if (remaining <= 60) timer.classList.add('warning');
        }

        // === –ß–ê–¢ ===
        window.sendMessage = async () => {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            
            gameState.messages.push({
                author: gameState.currentPlayer.name,
                text: msg,
                timestamp: Date.now()
            });
            
            await saveRoomData();
            input.value = '';
        }

        function addSystemMessage(text) {
            gameState.messages.push({
                author: '–°–ò–°–¢–ï–ú–ê',
                text,
                timestamp: Date.now(),
                isSystem: true
            });
        }

        function updateChat() {
            const messages = document.getElementById('chatMessages');
            messages.innerHTML = gameState.messages.map(m => `
                <div class="chat-message ${m.isSystem ? 'system' : ''}">
                    <div class="chat-message-author">${m.author}</div>
                    <div>${m.text}</div>
                </div>
            `).join('');
            messages.scrollTop = messages.scrollHeight;
        }

        document.getElementById('chatInput')?.addEventListener('keypress', e => {
            if (e.key === 'Enter') window.sendMessage();
        });

        // === –ì–û–õ–û–°–£–í–ê–ù–ù–Ø ===
        async function startVoting() {
            gameState.phase = 'voting';
            gameState.votingResults = {};
            await saveRoomData();
            addSystemMessage('–ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –ø–æ—á–∞–ª–æ—Å—è!');
            await saveRoomData();
            showVoting();
        }

        function showVoting() {
            document.getElementById('votingSection').style.display = 'block';
            document.getElementById('timerContainer').style.display = 'none';
            
            const alive = gameState.players.filter(p => !p.eliminated && p.id !== gameState.currentPlayer.id);
            const voted = gameState.votingResults[gameState.currentPlayer.id];
            document.getElementById('submitVoteBtn').disabled = voted;
            
            const container = document.getElementById('voteContainer');
            container.innerHTML = alive.map(p => `
                <div class="vote-option ${gameState.currentVote === p.id ? 'selected' : ''}" 
                     onclick="selectVote('${p.id}')">
                    <div style="font-size: 1.3rem; font-weight: 500;">${p.name}</div>
                    <div style="font-size: 0.9rem; color: var(--metal);">${p.character.profession}</div>
                </div>
            `).join('');
        }

        window.selectVote = (id) => {
            if (gameState.votingResults[gameState.currentPlayer.id]) return;
            gameState.currentVote = id;
            showVoting();
        }

        window.submitVote = async () => {
            if (!gameState.currentVote) return alert('–û–±–µ—Ä—ñ—Ç—å –≥—Ä–∞–≤—Ü—è');
            if (gameState.votingResults[gameState.currentPlayer.id]) return alert('–í–∏ –≤–∂–µ –ø—Ä–æ–≥–æ–ª–æ—Å—É–≤–∞–ª–∏');

            gameState.votingResults[gameState.currentPlayer.id] = gameState.currentVote;
            await saveRoomData();
            
            document.getElementById('submitVoteBtn').disabled = true;
            alert('–í–∞—à –≥–æ–ª–æ—Å –ø—Ä–∏–π–Ω—è—Ç–æ!');

            if (gameState.isHost) checkVotingComplete();
        }

        async function checkVotingComplete() {
            const alive = gameState.players.filter(p => !p.eliminated);
            if (Object.keys(gameState.votingResults).length < alive.length) return;

            // –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫
            const votes = {};
            Object.values(gameState.votingResults).forEach(id => {
                votes[id] = (votes[id] || 0) + 1;
            });

            let max = 0, eliminatedId = null;
            Object.entries(votes).forEach(([id, count]) => {
                if (count > max) {
                    max = count;
                    eliminatedId = id;
                }
            });

            if (eliminatedId) {
                const player = gameState.players.find(p => p.id === eliminatedId);
                if (player) {
                    player.eliminated = true;
                    
                    const story = await generateEliminationStory(player, gameState);
                    const survivors = gameState.players.filter(p => !p.eliminated);
                    
                    showEliminationModal(player, survivors, story);
                    addSystemMessage(`${player.name} –≤–∏–∫–ª—é—á–µ–Ω–∏–π! (${max} –≥–æ–ª–æ—Å—ñ–≤)`);
                }
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫—ñ–Ω—Ü—è
            const aliveNow = gameState.players.filter(p => !p.eliminated).length;
            if (aliveNow <= gameState.bunkerCapacity) {
                gameState.phase = 'end';
                await saveRoomData();
                
                setTimeout(async () => {
                    gameState.finalStory = await generateFinalStory(gameState);
                    await saveRoomData();
                    endGame();
                }, 3000);
            } else {
                gameState.phase = 'discussion';
                gameState.timerStartTime = Date.now();
                gameState.votingResults = {};
                await saveRoomData();
                addSystemMessage('–ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –æ–±–≥–æ–≤–æ—Ä–µ–Ω–Ω—è');
                await saveRoomData();
            }
        }

        function showEliminationModal(player, survivors, story) {
            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="modal-title">üíÄ –í–ò–ö–õ–Æ–ß–ï–ù–ù–Ø</div>
                <div class="eliminated-player">
                    <div style="font-size: 2rem; margin-bottom: 10px;">${player.name}</div>
                    <div style="font-size: 1.2rem; color: var(--metal);">${player.character.profession}</div>
                </div>
                <div style="margin: 30px 0; font-size: 1.15rem; line-height: 1.8; color: var(--light);">
                    ${story}
                </div>
                <div class="survivors-list">
                    <div style="font-size: 1.5rem; color: var(--bunker-green); margin-bottom: 15px; text-align: center;">
                        –ó–∞–ª–∏—à–∏–ª–æ—Å—è: ${survivors.length}
                    </div>
                    ${survivors.map(s => `<div style="padding: 8px;">${s.name} - ${s.character.profession}</div>`).join('')}
                </div>
            `;
            document.getElementById('overlay').classList.add('show');
        }

        window.closeModal = () => {
            document.getElementById('overlay').classList.remove('show');
        }

        // === –ö–Ü–ù–ï–¶–¨ ===
        function endGame() {
            showScreen('endScreen');
            
            const winners = gameState.players.filter(p => !p.eliminated);
            const container = document.getElementById('winnersContainer');
            
            container.innerHTML = `
                <div style="background: rgba(59, 186, 92, 0.2); border: 3px solid var(--bunker-green); padding: 30px; border-radius: 12px;">
                    <div style="font-size: 2.5rem; color: var(--bunker-green); text-align: center; margin-bottom: 20px;">
                        üéâ –í–ò–ñ–ò–í–®–ò–•: ${winners.length}
                    </div>
                    ${winners.map(w => `
                        <div style="margin: 15px 0; padding: 20px; background: rgba(13, 13, 13, 0.6); border-radius: 8px; border-left: 4px solid var(--bunker-green);">
                            <div style="font-size: 1.5rem; color: var(--accent);">${w.name}</div>
                            <div style="font-size: 1.1rem; color: var(--bunker-green); margin-top: 5px;">${w.character.profession}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-top: 30px; padding: 30px; background: rgba(26, 26, 26, 0.95); border: 3px solid var(--accent); border-radius: 12px;">
                    <div style="font-size: 2rem; color: var(--accent); text-align: center; margin-bottom: 20px;">
                        üìñ –ï–ü–Ü–õ–û–ì
                    </div>
                    <div style="font-size: 1.2rem; line-height: 2; color: var(--light); text-align: center;">
                        ${gameState.finalStory || '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...'}
                    </div>
                </div>
            `;
        }

        // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç –ø—Ä–∏ URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ
        const urlParams = new URLSearchParams(window.location.search);
        const roomParam = urlParams.get('room');
        if (roomParam) {
            document.getElementById('roomCodeInput').value = roomParam;
            showJoinRoom();
        }
    </script>
</body>
</html>
